name: Level 1 Testing Workflow

on:
  push:
    branches: [feat/m2-track*]
  pull_request:
    branches: [master, develop]
  workflow_dispatch: # Manual trigger
    inputs:
      network:
        description: 'Network to test on'
        required: true
        default: 'hardhat'
        type: choice
        options:
          - hardhat
          - base-sepolia

jobs:
  level1-workflow-test:
    runs-on: ubuntu-latest

    env:
      # Use GitHub Secrets for sensitive data
      PRIVATE_KEY: ${{ secrets.LEVEL1_DEV_PRIVATE_KEY }}
      BASESCAN_API_KEY: ${{ secrets.BASESCAN_API_KEY }}
      BASE_RPC_URL: ${{ secrets.BASE_SEPOLIA_RPC_URL }}

      # Level 1 Configuration (all same address for testing)
      MULTISIG_LEVEL: 1
      MULTISIG_NAME: "Level 1 Dev Testing"
      MULTISIG_THRESHOLD: 1

      # Mock API URL
      VLN_URL: "https://mock-api.402.vln.gg"

      # Test mode
      USE_HARDWARE_WALLET: false
      REPORT_GAS: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Compile contracts
        run: npm run compile

      - name: Run Level 1 Workflow Test
        run: npx hardhat run scripts/test-level1-workflow.ts --network ${{ github.event.inputs.network || 'hardhat' }}

      - name: Generate test report
        if: always()
        run: |
          echo "## Level 1 Workflow Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Network:** ${{ github.event.inputs.network || 'hardhat' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u)" >> $GITHUB_STEP_SUMMARY

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: level1-test-results
          path: |
            deployments/
            logs/
          retention-days: 7

  mock-api-integration:
    runs-on: ubuntu-latest
    needs: level1-workflow-test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Start mock API server
        run: |
          # Create simple mock API for testing
          cat > mock-api.js << 'EOF'
          const express = require('express');
          const app = express();
          app.use(express.json());

          app.get('/health', (req, res) => {
            res.json({ status: 'ok', mock: true });
          });

          app.post('/authorize', (req, res) => {
            res.json({
              success: true,
              authorized: true,
              requestId: `req_${Date.now()}`,
              timestamp: Date.now()
            });
          });

          app.post('/merchant/register', (req, res) => {
            res.json({
              success: true,
              merchantId: `merchant_${Date.now()}`,
              requestId: `req_${Date.now()}`
            });
          });

          app.listen(3000, () => {
            console.log('Mock API running on port 3000');
          });
          EOF

          npm install express &
          node mock-api.js &
          sleep 3

      - name: Test mock API endpoints
        run: |
          # Test health endpoint
          curl http://localhost:3000/health

          # Test authorize endpoint
          curl -X POST http://localhost:3000/authorize \
            -H "Content-Type: application/json" \
            -d '{"tx_hash": "0xtest"}'

          # Test merchant registration
          curl -X POST http://localhost:3000/merchant/register \
            -H "Content-Type: application/json" \
            -d '{"payout_address": "0xtest"}'

      - name: Shutdown mock API
        if: always()
        run: pkill -f "node mock-api.js" || true
